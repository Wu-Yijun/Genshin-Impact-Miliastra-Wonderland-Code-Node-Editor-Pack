import assert from "assert";

export interface ConcreteMap {
  /** Each map is a map of concrete_id --> type */
  maps: number[][];
  /** generic_id:pin_type:pin_index --> index in maps */
  pins: Map<string, number>;
}

function get_concrete_index(
  generic_id: number,
  pin_type: number,
  pin_index: number,
  type: number,
  turn_off_log = false,
) {
  const id = CONCRETE_MAP.pins.get(
    generic_id + ":" + pin_type + ":" + pin_index,
  );
  if (id === undefined) {
    if (turn_off_log === false) {
      console.warn(
        "Cannot find concrete map with:",
        generic_id,
        pin_type,
        pin_index,
      );
      console.log("It may be non-reflective pin.");
    }
    return 0;
  }
  const map = CONCRETE_MAP.maps[id];
  const index = map.indexOf(type);
  if (index === -1) {
    if (turn_off_log === false) {
      console.warn("Type", type, "Is not in map!");
    }
    return 0;
  }
  return index;
}
function get_concrete_type(
  generic_id: number,
  pin_type: number,
  pin_index: number,
  index: number,
  turn_off_log = false,
) {
  const id = CONCRETE_MAP.pins.get(
    generic_id + ":" + pin_type + ":" + pin_index,
  );
  if (id === undefined) {
    if (turn_off_log === false) {
      console.warn(
        "Cannot find concrete map with:",
        generic_id,
        pin_type,
        pin_index,
      );
      console.log("It may be non-reflective pin.");
    }
    return 0;
  }
  const map = CONCRETE_MAP.maps[id];
  return map[index];
}

export function stringify_concrete_map(map = CONCRETE_MAP) {
  const m = map.maps.map(x => x.join(",")).join("|");
  const p = [...map.pins.entries()].map(([k, v]) => k + "," + v).join("|");
  return [m, p].join(";");
}
export function parse_concrete_map(str: string): ConcreteMap {
  const [m, p] = str.split(";");
  const maps = m.split("|").map(str => str.split(",").map(x => parseInt(x)));
  const pins = new Map(p.split("|").map(str => str.split(",")).map(x => [x[0], parseInt(x[1])]))
  return { maps, pins };
}

export const CONCRETE_MAP: ConcreteMap = {
  maps: [
    [
      3,
      6,
      1,
      2,
      5,
      12,
      4,
      8,
      11,
      13,
      7,
      10,
      15,
      9,
      20,
      21,
      22,
      23,
      17,
      24,
      27,
    ],
    [
      3,
      5,
      4,
      6,
      2,
      1,
      7,
      8,
      9,
      10,
      11,
      12,
      13,
      15,
      20,
      21,
      22,
      23,
      17,
      24,
      27,
    ],
    [
      1,
      2,
      3,
      4,
      5,
      6,
      7,
      8,
      9,
      10,
      11,
      12,
      13,
      15,
      20,
      21,
      22,
      23,
      17,
      24,
      27,
    ],
    [
      3,
      5,
      4,
      6,
      12,
      2,
      1,
      21,
      17,
      20,
      8,
      10,
      9,
      11,
      15,
      7,
      13,
      23,
      24,
      22,
    ],
    [
      4,
      3,
      6,
      1,
      2,
      5,
      12,
      8,
      11,
      13,
      7,
      10,
      15,
      9,
      20,
      21,
      22,
      23,
      17,
      24,
    ],
    [
      8,
      11,
      13,
      7,
      10,
      15,
      9,
      22,
      23,
      24,
    ],
    [
      8,
      10,
      9,
      11,
      15,
      7,
      13,
      23,
      24,
      22,
    ],
    [
      3,
      6,
      1,
      2,
      5,
      12,
      4,
      20,
      21,
      17,
    ],
    [
      8,
      8,
      8,
      8,
      8,
      8,
      8,
      8,
      8,
      8,
    ],
    [
      9,
      13,
      10,
      7,
      8,
      11,
      15,
      22,
      23,
      24,
    ],
    [
      4,
      1,
      5,
      2,
      3,
      6,
      12,
      20,
      21,
      17,
    ],
    [
      6,
      2,
      1,
      12,
      17,
      3,
      5,
      20,
      21,
    ],
    [3, 5, 6],
  ],
  pins: new Map([
    ["22:3:2", 0],
    ["36:4:3", 0],
    ["36:4:4", 0],
    ["428:4:3", 0],
    ["428:4:4", 0],
    ["445:3:2", 0],
    ["459:4:0", 0],
    ["50:4:0", 0],
    ["3:3:0", 0],
    ["323:3:1", 1],
    ["149:4:0", 1],
    ["151:4:0", 1],
    ["200:3:0", 1],
    ["200:3:1", 1],
    ["200:4:0", 1],
    ["202:3:0", 1],
    ["202:3:1", 1],
    ["202:4:0", 1],
    ["204:3:0", 1],
    ["204:3:1", 1],
    ["204:4:0", 1],
    ["206:3:0", 1],
    ["206:3:1", 1],
    ["206:4:0", 1],
    ["209:3:0", 1],
    ["209:3:1", 1],
    ["209:4:0", 1],
    ["211:3:0", 1],
    ["211:3:1", 1],
    ["211:4:0", 1],
    ["213:3:0", 1],
    ["213:3:1", 1],
    ["213:4:0", 1],
    ["216:3:0", 1],
    ["216:3:1", 1],
    ["216:4:0", 1],
    ["218:3:0", 1],
    ["218:3:1", 1],
    ["218:4:0", 1],
    ["222:3:0", 1],
    ["222:3:1", 1],
    ["222:3:2", 1],
    ["222:4:0", 1],
    ["230:3:0", 1],
    ["230:3:1", 1],
    ["230:4:0", 1],
    ["231:3:0", 1],
    ["231:3:1", 1],
    ["231:4:0", 1],
    ["232:3:0", 1],
    ["232:3:1", 1],
    ["232:4:0", 1],
    ["233:3:0", 1],
    ["233:3:1", 1],
    ["233:4:0", 1],
    ["337:4:0", 2],
    ["351:4:3", 2],
    ["351:4:4", 2],
    ["1158:4:0", 3],
    ["1578:4:0", 3],
    ["1788:3:100", 3],
    ["1788:3:102", 3],
    ["1788:3:104", 3],
    ["1788:3:106", 3],
    ["1788:3:108", 3],
    ["1788:3:10", 3],
    ["1788:3:110", 3],
    ["1788:3:112", 3],
    ["1788:3:114", 3],
    ["1788:3:116", 3],
    ["1788:3:118", 3],
    ["1788:3:120", 3],
    ["1788:3:122", 3],
    ["1788:3:124", 3],
    ["1788:3:126", 3],
    ["1788:3:128", 3],
    ["1788:3:12", 3],
    ["1788:3:130", 3],
    ["1788:3:132", 3],
    ["1788:3:134", 3],
    ["1788:3:136", 3],
    ["1788:3:138", 3],
    ["1788:3:140", 3],
    ["1788:3:142", 3],
    ["1788:3:144", 3],
    ["1788:3:146", 3],
    ["1788:3:148", 3],
    ["1788:3:14", 3],
    ["1788:3:150", 3],
    ["1788:3:152", 3],
    ["1788:3:154", 3],
    ["1788:3:156", 3],
    ["1788:3:158", 3],
    ["1788:3:160", 3],
    ["1788:3:162", 3],
    ["1788:3:164", 3],
    ["1788:3:166", 3],
    ["1788:3:168", 3],
    ["1788:3:16", 3],
    ["1788:3:170", 3],
    ["1788:3:172", 3],
    ["1788:3:174", 3],
    ["1788:3:176", 3],
    ["1788:3:178", 3],
    ["1788:3:180", 3],
    ["1788:3:182", 3],
    ["1788:3:184", 3],
    ["1788:3:186", 3],
    ["1788:3:188", 3],
    ["1788:3:18", 3],
    ["1788:3:190", 3],
    ["1788:3:192", 3],
    ["1788:3:194", 3],
    ["1788:3:196", 3],
    ["1788:3:198", 3],
    ["1788:3:20", 3],
    ["1788:3:22", 3],
    ["1788:3:24", 3],
    ["1788:3:26", 3],
    ["1788:3:28", 3],
    ["1788:3:2", 3],
    ["1788:3:30", 3],
    ["1788:3:32", 3],
    ["1788:3:34", 3],
    ["1788:3:36", 3],
    ["1788:3:38", 3],
    ["1788:3:40", 3],
    ["1788:3:42", 3],
    ["1788:3:44", 3],
    ["1788:3:46", 3],
    ["1788:3:48", 3],
    ["1788:3:4", 3],
    ["1788:3:50", 3],
    ["1788:3:52", 3],
    ["1788:3:54", 3],
    ["1788:3:56", 3],
    ["1788:3:58", 3],
    ["1788:3:60", 3],
    ["1788:3:62", 3],
    ["1788:3:64", 3],
    ["1788:3:66", 3],
    ["1788:3:68", 3],
    ["1788:3:6", 3],
    ["1788:3:70", 3],
    ["1788:3:72", 3],
    ["1788:3:74", 3],
    ["1788:3:76", 3],
    ["1788:3:78", 3],
    ["1788:3:80", 3],
    ["1788:3:82", 3],
    ["1788:3:84", 3],
    ["1788:3:86", 3],
    ["1788:3:88", 3],
    ["1788:3:8", 3],
    ["1788:3:90", 3],
    ["1788:3:92", 3],
    ["1788:3:94", 3],
    ["1788:3:96", 3],
    ["1788:3:98", 3],
    ["948:3:2", 3],
    ["1158:3:1", 3],
    ["1298:3:1", 3],
    ["1368:3:1", 3],
    ["1438:3:1", 3],
    ["1508:4:0", 3],
    ["1788:3:101", 3],
    ["1788:3:103", 3],
    ["1788:3:105", 3],
    ["1788:3:107", 3],
    ["1788:3:109", 3],
    ["1788:3:111", 3],
    ["1788:3:113", 3],
    ["1788:3:115", 3],
    ["1788:3:117", 3],
    ["1788:3:119", 3],
    ["1788:3:11", 3],
    ["1788:3:121", 3],
    ["1788:3:123", 3],
    ["1788:3:125", 3],
    ["1788:3:127", 3],
    ["1788:3:129", 3],
    ["1788:3:131", 3],
    ["1788:3:133", 3],
    ["1788:3:135", 3],
    ["1788:3:137", 3],
    ["1788:3:139", 3],
    ["1788:3:13", 3],
    ["1788:3:141", 3],
    ["1788:3:143", 3],
    ["1788:3:145", 3],
    ["1788:3:147", 3],
    ["1788:3:149", 3],
    ["1788:3:151", 3],
    ["1788:3:153", 3],
    ["1788:3:155", 3],
    ["1788:3:157", 3],
    ["1788:3:159", 3],
    ["1788:3:15", 3],
    ["1788:3:161", 3],
    ["1788:3:163", 3],
    ["1788:3:165", 3],
    ["1788:3:167", 3],
    ["1788:3:169", 3],
    ["1788:3:171", 3],
    ["1788:3:173", 3],
    ["1788:3:175", 3],
    ["1788:3:177", 3],
    ["1788:3:179", 3],
    ["1788:3:17", 3],
    ["1788:3:181", 3],
    ["1788:3:183", 3],
    ["1788:3:185", 3],
    ["1788:3:187", 3],
    ["1788:3:189", 3],
    ["1788:3:191", 3],
    ["1788:3:193", 3],
    ["1788:3:195", 3],
    ["1788:3:197", 3],
    ["1788:3:19", 3],
    ["1788:3:1", 3],
    ["1788:3:21", 3],
    ["1788:3:23", 3],
    ["1788:3:25", 3],
    ["1788:3:27", 3],
    ["1788:3:29", 3],
    ["1788:3:31", 3],
    ["1788:3:33", 3],
    ["1788:3:35", 3],
    ["1788:3:37", 3],
    ["1788:3:39", 3],
    ["1788:3:3", 3],
    ["1788:3:41", 3],
    ["1788:3:43", 3],
    ["1788:3:45", 3],
    ["1788:3:47", 3],
    ["1788:3:49", 3],
    ["1788:3:51", 3],
    ["1788:3:53", 3],
    ["1788:3:55", 3],
    ["1788:3:57", 3],
    ["1788:3:59", 3],
    ["1788:3:5", 3],
    ["1788:3:61", 3],
    ["1788:3:63", 3],
    ["1788:3:65", 3],
    ["1788:3:67", 3],
    ["1788:3:69", 3],
    ["1788:3:71", 3],
    ["1788:3:73", 3],
    ["1788:3:75", 3],
    ["1788:3:77", 3],
    ["1788:3:79", 3],
    ["1788:3:7", 3],
    ["1788:3:81", 3],
    ["1788:3:83", 3],
    ["1788:3:85", 3],
    ["1788:3:87", 3],
    ["1788:3:89", 3],
    ["1788:3:91", 3],
    ["1788:3:93", 3],
    ["1788:3:95", 3],
    ["1788:3:97", 3],
    ["1788:3:99", 3],
    ["1788:3:9", 3],
    ["948:3:1", 3],
    ["18:3:0", 4],
    ["18:3:1", 4],
    ["19:3:1", 4],
    ["100:3:0", 5],
    ["100:3:1", 5],
    ["107:3:0", 5],
    ["114:3:0", 5],
    ["121:3:0", 5],
    ["128:3:0", 5],
    ["135:3:0", 5],
    ["142:3:0", 5],
    ["153:3:0", 5],
    ["160:3:0", 5],
    ["169:4:0", 5],
    ["1088:3:0", 6],
    ["1088:3:1", 6],
    ["1928:4:0", 6],
    ["1928:4:1", 6],
    ["1938:4:0", 6],
    ["1938:4:1", 6],
    ["149:3:0", 6],
    ["151:3:0", 6],
    ["167:3:0", 6],
    ["114:3:1", 7],
    ["121:3:1", 7],
    ["128:4:0", 7],
    ["135:3:1", 7],
    ["160:3:2", 7],
    ["169:3:10", 7],
    ["169:3:11", 7],
    ["169:3:12", 7],
    ["169:3:13", 7],
    ["169:3:14", 7],
    ["169:3:15", 7],
    ["169:3:16", 7],
    ["169:3:17", 7],
    ["169:3:18", 7],
    ["169:3:19", 7],
    ["169:3:1", 7],
    ["169:3:20", 7],
    ["169:3:21", 7],
    ["169:3:22", 7],
    ["169:3:23", 7],
    ["169:3:24", 7],
    ["169:3:25", 7],
    ["169:3:26", 7],
    ["169:3:27", 7],
    ["169:3:28", 7],
    ["169:3:29", 7],
    ["169:3:2", 7],
    ["169:3:30", 7],
    ["169:3:31", 7],
    ["169:3:32", 7],
    ["169:3:33", 7],
    ["169:3:34", 7],
    ["169:3:35", 7],
    ["169:3:36", 7],
    ["169:3:37", 7],
    ["169:3:38", 7],
    ["169:3:39", 7],
    ["169:3:3", 7],
    ["169:3:40", 7],
    ["169:3:41", 7],
    ["169:3:42", 7],
    ["169:3:43", 7],
    ["169:3:44", 7],
    ["169:3:45", 7],
    ["169:3:46", 7],
    ["169:3:47", 7],
    ["169:3:48", 7],
    ["169:3:49", 7],
    ["169:3:4", 7],
    ["169:3:50", 7],
    ["169:3:51", 7],
    ["169:3:52", 7],
    ["169:3:53", 7],
    ["169:3:54", 7],
    ["169:3:55", 7],
    ["169:3:56", 7],
    ["169:3:57", 7],
    ["169:3:58", 7],
    ["169:3:59", 7],
    ["169:3:5", 7],
    ["169:3:60", 7],
    ["169:3:61", 7],
    ["169:3:62", 7],
    ["169:3:63", 7],
    ["169:3:64", 7],
    ["169:3:65", 7],
    ["169:3:66", 7],
    ["169:3:67", 7],
    ["169:3:68", 7],
    ["169:3:69", 7],
    ["169:3:6", 7],
    ["169:3:70", 7],
    ["169:3:71", 7],
    ["169:3:72", 7],
    ["169:3:73", 7],
    ["169:3:74", 7],
    ["169:3:75", 7],
    ["169:3:76", 7],
    ["169:3:77", 7],
    ["169:3:78", 7],
    ["169:3:79", 7],
    ["169:3:7", 7],
    ["169:3:80", 7],
    ["169:3:81", 7],
    ["169:3:82", 7],
    ["169:3:83", 7],
    ["169:3:84", 7],
    ["169:3:85", 7],
    ["169:3:86", 7],
    ["169:3:87", 7],
    ["169:3:88", 7],
    ["169:3:89", 7],
    ["169:3:8", 7],
    ["169:3:90", 7],
    ["169:3:91", 7],
    ["169:3:92", 7],
    ["169:3:93", 7],
    ["169:3:94", 7],
    ["169:3:95", 7],
    ["169:3:96", 7],
    ["169:3:97", 7],
    ["169:3:98", 7],
    ["169:3:99", 7],
    ["169:3:9", 7],
    ["121:4:0", 8],
    ["509:3:0", 9],
    ["509:4:0", 10],
    ["14:3:0", 11],
    ["14:3:1", 11],
    ["647:3:3", 12],
  ]),
};


if (import.meta.main) {
  const s = stringify_concrete_map();
  const t = parse_concrete_map(s);
  assert(JSON.stringify(t), JSON.stringify(CONCRETE_MAP));
  assert(s, stringify_concrete_map(t));
  // console.log(s, t)
  console.log("Check pass!");
}